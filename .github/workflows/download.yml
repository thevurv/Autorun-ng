name: Download

on:
    push:
        branches: [master]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Install just
              uses: extractions/setup-just@v2

            - name: Cache cargo registry
              uses: actions/cache@v3
              with:
                  path: ~/.cargo/registry
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache cargo index
              uses: actions/cache@v3
              with:
                  path: ~/.cargo/git
                  key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache target directory
              uses: actions/cache@v3
              with:
                  path: target
                  key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

            - name: Build with just
              run: just build-release

            - name: Create zip archive
              run: |
                  cd release
                  zip -r ../autorun-${{ runner.os }}.zip .

            - name: Upload release archive
              uses: actions/upload-artifact@v4
              with:
                  name: Autorun ${{ runner.os }}
                  path: autorun-${{ runner.os }}.zip
                  if-no-files-found: error
